<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProtokollApp</title>

  <style>
    /* defaults = HELL */
    :root{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

      --bg: #f4f6f9;
      --card: #ffffff;
      --text: #101828;
      --muted: #667085;
      --border: #e4e7ec;
      --border2: #d0d5dd;
      --shadow: 0 1px 0 rgba(16,24,40,0.04);
      --primary: #1f6fff;
      --danger: #d92d20;

      --radius: 16px;
      --radius2: 14px;

      --pad: 14px;
      --h1: 18px;
      --h2: 14px;
      --base: 16px;

      --focus: 0 0 0 4px rgba(31,111,255,.16);
      --chipBg: #f2f4f7;
      --chipBd: #e4e7ec;

      --headerBg: #ffffff;
      --stickyBg: rgba(255,255,255,.92);
      --stickyBd: rgba(228,231,236,.9);
      --glass: saturate(180%) blur(10px);
    }

    /* DUNKEL theme overrides */
    [data-theme="dunkel"]{
      --bg: #0b1020;
      --card: #111a33;
      --text: #f2f4f7;
      --muted: #c2c7d0;
      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.16);
      --shadow: 0 10px 24px rgba(0,0,0,.24);
      --primary: #7aa7ff;
      --danger: #ff6b6b;

      --chipBg: rgba(255,255,255,.06);
      --chipBd: rgba(255,255,255,.12);

      --headerBg: rgba(17,26,51,.72);
      --stickyBg: rgba(17,26,51,.78);
      --stickyBd: rgba(255,255,255,.12);
      --focus: 0 0 0 4px rgba(122,167,255,.20);
    }

    body{ margin:0; background: var(--bg); color: var(--text); }
    header{
      background: var(--headerBg);
      border-bottom: 1px solid var(--border);
      position: sticky; top:0; z-index: 30;
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
    }
    .header-inner{
      max-width: 980px;
      margin: 0 auto;
      padding: 12px 12px;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    }
    h1{ margin:0; font-size: 18px; letter-spacing: .2px; }
    .subtitle{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      max-width: 70vw;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    main{ max-width: 980px; margin: 12px auto; padding: 0 12px 92px; }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: var(--shadow);
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap: 12px; }
    .row{ display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    .sep{ height: 1px; background: color-mix(in srgb, var(--border) 60%, transparent); margin: 10px 0; }

    label{ display:block; font-size: 13px; color: color-mix(in srgb, var(--text) 84%, var(--muted)); margin-bottom: 6px; font-weight: 800; }

    input[type="text"], input[type="number"], textarea, select{
      width:100%; box-sizing:border-box;
      padding: 14px 12px;
      border: 1px solid var(--border2);
      border-radius: 14px;
      background: color-mix(in srgb, var(--card) 92%, transparent);
      color: var(--text);
      font-size: 16px;
      outline: none;
    }
    textarea{ min-height: 110px; resize: vertical; }
    input:focus, textarea:focus, select:focus{
      border-color: color-mix(in srgb, var(--primary) 70%, var(--border2));
      box-shadow: var(--focus);
    }
    select{ appearance: none; }

    button{
      border: 1px solid var(--border2);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 900;
      font-size: 15px;
      min-height: 46px;
    }
    button.primary{ background: var(--primary); border-color: var(--primary); color:#fff; }
    button.danger{ background: var(--danger); border-color: var(--danger); color:#fff; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .muted{ color: var(--muted); font-size: 13px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; color: var(--muted); }

    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--chipBg);
      border: 1px solid var(--chipBd);
      font-size: 12px;
      font-weight: 800;
      color: color-mix(in srgb, var(--text) 86%, var(--muted));
    }

    .badge{
      font-size: 12px; padding: 5px 10px;
      background: color-mix(in srgb, var(--primary) 12%, transparent);
      border: 1px solid color-mix(in srgb, var(--primary) 26%, var(--border));
      border-radius: 999px;
      font-weight: 900;
      color: color-mix(in srgb, var(--text) 86%, var(--muted));
    }

    .section-title{
      font-size: 14px;
      font-weight: 900;
      margin: 0 0 6px 0;
      letter-spacing: .2px;
    }

    .entries{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
    .entry-head{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
    .entry-meta{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .small{ font-size: 14px; line-height: 1.5; }

    .thumbs{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-top:10px; }
    .thumbs img{
      width:100%; height:110px; object-fit:cover;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      cursor: zoom-in;
    }

    @media (min-width: 860px){
      .grid{ grid-template-columns: repeat(12, 1fr); gap: 10px; }
      .col-12{ grid-column: span 12; }
      .col-6{ grid-column: span 6; }
      .col-4{ grid-column: span 4; }
      .col-3{ grid-column: span 3; }
      .entries{ grid-template-columns: repeat(12, 1fr); }
      .entry{ grid-column: span 6; }
      .thumbs{ grid-template-columns: repeat(6, 1fr); }
      .thumbs img{ height: 82px; }
    }

    .statusbar{
      max-width: 980px;
      margin: 0 auto;
      padding: 0 12px 10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .stickybar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 40;
      background: var(--stickyBg);
      border-top: 1px solid var(--stickyBd);
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
    }
    .stickybar-inner{
      max-width: 980px;
      margin: 0 auto;
      padding: 10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .sticky-actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .modal{
      position: fixed; inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 60;
      background: rgba(0,0,0,.76);
      padding: 12px;
    }
    .modal.open{ display:flex; }
    .modal-card{
      width: min(980px, 100%);
      background: #000;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 40px rgba(0,0,0,.55);
      position: relative;
    }
    .modal-card img{
      width:100%;
      height: auto;
      display:block;
      max-height: 84vh;
      object-fit: contain;
      background:#000;
    }
    .modal-top{
      position:absolute; left:0; right:0; top:0;
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      padding: 10px;
      background: linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,0));
      color:#fff;
      font-weight: 800;
      font-size: 13px;
    }
    .modal-top button{
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.20);
      color:#fff;
      min-height: 38px;
      padding: 8px 10px;
      border-radius: 12px;
    }

    .file-input-hidden{
      position:absolute !important;
      width:1px; height:1px;
      padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0);
      white-space:nowrap; border:0;
    }
    .file-picker-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .file-name{
      font-size: 13px;
      color: var(--muted);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: min(520px, 70vw);
    }
    .file-clear{ min-height: 46px; }
  </style>
</head>

<body data-theme="hell">
<header>
  <div class="header-inner">
    <div style="min-width:0;">
      <h1>Begehungsprotokoll</h1>
      <div class="subtitle" id="projectSubtitle">Projekt: —</div>
    </div>

    <div class="row" style="justify-content:flex-end;">
      <span class="chip" id="libStatus">Libs: <span id="libText">lade…</span></span>
      <button type="button" id="themeBtn">Design: Hell</button>
    </div>
  </div>

  <div class="statusbar">
    <div class="row">
      <span class="badge" id="countBadge">0 Punkte</span>
      <span class="chip" id="lastExportChip">Letzter Export: —</span>
    </div>
    <div class="mono" id="nowText"></div>
  </div>
</header>

<main>
  <div class="card">
    <div class="section-title">Protokollkopf</div>
    <div class="muted">Diese Angaben erscheinen im PDF-Titel.</div>
    <div class="sep"></div>

    <div class="grid">
      <div class="col-6">
        <label for="project">Projekt</label>
        <input id="project" type="text" placeholder="z. B. Neubau Baugebiet Süd" />
      </div>
      <div class="col-6">
        <label for="creator">Ersteller</label>
        <input id="creator" type="text" placeholder="z. B. Max Mustermann" />
      </div>
    </div>
  </div>

  <div style="height:12px;"></div>

  <div class="card">
    <div class="section-title">Rahmendaten</div>
    <div class="sep"></div>

    <div class="grid">
      <div class="col-3">
        <label for="weather">Wetter</label>
        <select id="weather">
          <option value="">(leer)</option>
          <option>Sonnig</option>
          <option>Leicht bewölkt</option>
          <option>Bewölkt</option>
          <option>Nebel</option>
          <option>Nieselregen</option>
          <option>Regen</option>
          <option>Starkregen</option>
          <option>Schnee</option>
          <option>Windig</option>
          <option>Gewitter</option>
        </select>
        <div class="row" style="margin-top:10px;">
          <button id="btnWeather" type="button">Wetter holen</button>
        </div>
      </div>

      <div class="col-3">
        <label for="temp">Temperatur °C</label>
        <input id="temp" type="number" step="0.1" placeholder="z. B. 8.5" />
      </div>
    </div>
  </div>

  <div style="height:12px;"></div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="section-title">Neuer Punkt</div>
        <div class="muted">Pflicht: Mangel / Feststellung</div>
      </div>
      <button id="btnClearAll" class="danger" type="button" disabled>Alles löschen</button>
    </div>

    <div class="sep"></div>

    <div class="grid">
      <div class="col-6">
        <label for="site">Standort</label>
        <input id="site" type="text" placeholder="z. B. Baustelle / Ort / Koordinaten" />
        <div class="row" style="margin-top:10px;">
          <button id="btnGeo" type="button">Standort automatisch</button>
        </div>
      </div>

      <div class="col-3">
        <label for="trackNoPoint">Streckennummer</label>
        <input id="trackNoPoint" type="text" inputmode="numeric" placeholder="z. B. 3610" />
      </div>

      <div class="col-3">
        <label for="kmPoint">km</label>
        <input id="kmPoint" type="text" inputmode="decimal" placeholder="z. B. 12,345" />
      </div>

      <div class="col-12">
        <label for="note">Mangel / Feststellung</label>
        <textarea id="note" placeholder="Beschreibe den Punkt …"></textarea>
      </div>

      <div class="col-12">
        <label>Fotos</label>

        <input id="photos" class="file-input-hidden" type="file" accept="image/*" multiple capture="environment" />

        <div class="file-picker-row">
          <button type="button" id="btnPickPhotos">Fotos auswählen</button>
          <span class="file-name" id="photoFileInfo">Keine Dateien ausgewählt</span>
          <button type="button" id="btnClearPhotos" class="file-clear" disabled>Auswahl löschen</button>
        </div>
      </div>
    </div>
  </div>

  <div class="entries" id="entries"></div>
</main>

<div class="stickybar">
  <div class="stickybar-inner">
    <div class="muted" id="stickyHint">Bereit.</div>
    <div class="sticky-actions">
      <button id="btnExportXlsx" type="button" disabled>Excel</button>
      <button id="btnExportPdf" type="button" disabled>PDF</button>
      <button id="btnExportZip" type="button" disabled>ZIP</button>
      <button id="btnAdd" class="primary" type="button">Punkt speichern</button>
    </div>
  </div>
</div>

<div class="modal" id="photoModal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-top">
      <div id="modalTitle">Foto</div>
      <button type="button" id="modalClose">Schließen</button>
    </div>
    <img id="modalImg" alt="Foto" />
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>

<script>
  const state = { entries: [] };
  const $ = (id) => document.getElementById(id);

  const projectEl = $("project");
  const creatorEl = $("creator");
  const projectSubtitle = $("projectSubtitle");

  const weatherEl = $("weather");
  const tempEl = $("temp");
  const btnWeather = $("btnWeather");

  const siteEl = $("site");
  const btnGeo = $("btnGeo");
  const trackNoPointEl = $("trackNoPoint");
  const kmPointEl = $("kmPoint");
  const noteEl = $("note");

  const photosEl = $("photos");
  const btnPickPhotos = $("btnPickPhotos");
  const photoFileInfo = $("photoFileInfo");
  const btnClearPhotos = $("btnClearPhotos");

  const entriesEl = $("entries");

  const btnAdd = $("btnAdd");
  const btnClearAll = $("btnClearAll");
  const btnExportXlsx = $("btnExportXlsx");
  const btnExportZip = $("btnExportZip");
  const btnExportPdf = $("btnExportPdf");

  const countBadge = $("countBadge");
  const nowText = $("nowText");
  const libText = $("libText");
  const lastExportChip = $("lastExportChip");
  const stickyHint = $("stickyHint");

  const themeBtn = $("themeBtn");

  const photoModal = $("photoModal");
  const modalImg = $("modalImg");
  const modalTitle = $("modalTitle");
  const modalClose = $("modalClose");

  function nowISO(){ return new Date().toISOString(); }
  function formatLocal(iso){
    const d = new Date(iso);
    return d.toLocaleString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }
  function formatDateDE(d){
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yyyy = String(d.getFullYear());
    return `${dd}.${mm}.${yyyy}`;
  }
  function uniqId(){ return Math.random().toString(16).slice(2)+"-"+Date.now().toString(16); }
  function safeFileName(s){ return (s||"").replace(/[\\/:*?"<>|]+/g,"_").trim().slice(0,120)||"datei"; }

  /* =========================
     PDF SAFE TEXT (ROBUST)
     ========================= */
  function pdfSafe(v){
    let s = String(v ?? "");
    if (s.normalize) s = s.normalize("NFKD");
    s = s.replace(/[\u0300-\u036f]/g, "");
    s = s
      .replaceAll("\u00A0", " ")
      .replaceAll("\u202F", " ")
      .replaceAll("\u2007", " ")
      .replaceAll("–", "-")
      .replaceAll("—", "-")
      .replaceAll("−", "-")
      .replaceAll("’", "'")
      .replaceAll("‘", "'")
      .replaceAll("“", '"')
      .replaceAll("”", '"')
      .replaceAll("•", "-")
      .replaceAll("…", "...")
      .replaceAll("\t", "  ");
    s = s.replace(/\r/g, "");
    s = s.replace(/[^\x0A\x20-\xFF]/g, "");
    s = s.replace(/[ ]{2,}/g, " ").trim();
    return s;
  }

  function setNowTicker(){ nowText.textContent = new Date().toLocaleString("de-DE"); }
  setNowTicker(); setInterval(setNowTicker,1000);

  function updateLibStatus(){
    const okXlsx=!!window.XLSX, okZip=!!window.JSZip, okPdf=!!(window.jspdf && window.jspdf.jsPDF);
    if(okXlsx && okZip && okPdf) { libText.textContent="bereit"; }
    else {
      const m=[]; if(!okXlsx)m.push("XLSX"); if(!okZip)m.push("ZIP"); if(!okPdf)m.push("PDF");
      libText.textContent="fehlt: "+m.join(", ");
    }
  }

  function updateProjectSubtitle(){
    const p = projectEl.value.trim();
    projectSubtitle.textContent = "Projekt: " + (p || "—");
  }
  projectEl.addEventListener("input", updateProjectSubtitle);
  updateProjectSubtitle();

  function updateButtons(){
    const has = state.entries.length > 0;
    btnClearAll.disabled = !has;

    const okXlsx=!!window.XLSX, okZip=!!window.JSZip, okPdf=!!(window.jspdf && window.jspdf.jsPDF);
    btnExportXlsx.disabled = !has || !okXlsx;
    btnExportZip.disabled  = !has || !okXlsx || !okZip;
    btnExportPdf.disabled  = !has || !okPdf;

    countBadge.textContent = `${state.entries.length} Punkt${state.entries.length===1?"":"e"}`;
    stickyHint.textContent = has ? "Bereit zum Export." : "Noch keine Punkte gespeichert.";
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function refreshPhotoPickerUI(){
    const files = photosEl.files ? Array.from(photosEl.files) : [];
    if(!files.length){
      photoFileInfo.textContent = "Keine Dateien ausgewählt";
      btnClearPhotos.disabled = true;
      return;
    }
    photoFileInfo.textContent = (files.length === 1) ? files[0].name : `${files.length} Dateien ausgewählt`;
    btnClearPhotos.disabled = false;
  }
  btnPickPhotos.addEventListener("click", () => photosEl.click());
  photosEl.addEventListener("change", refreshPhotoPickerUI);
  btnClearPhotos.addEventListener("click", ()=>{
    photosEl.value = "";
    refreshPhotoPickerUI();
  });
  refreshPhotoPickerUI();

  function readFilesAsDataUrls(fileList){
    const files=Array.from(fileList||[]);
    return Promise.all(files.map(f => new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>resolve({name:f.name,type:f.type||"application/octet-stream",dataUrl:r.result});
      r.onerror=reject;
      r.readAsDataURL(f);
    })));
  }

  function openPhoto(name, dataUrl){
    modalTitle.textContent = name || "Foto";
    modalImg.src = dataUrl;
    photoModal.classList.add("open");
  }
  function closePhoto(){
    photoModal.classList.remove("open");
    modalImg.src = "";
  }
  modalClose.addEventListener("click", closePhoto);
  photoModal.addEventListener("click", (e)=>{ if(e.target === photoModal) closePhoto(); });
  window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closePhoto(); });

  function renderEntries(){
    entriesEl.innerHTML = "";
    if(!state.entries.length) return;

    for(const e of [...state.entries].reverse()){
      const div = document.createElement("div");
      div.className = "card entry";

      const head = document.createElement("div");
      head.className = "entry-head";

      const left = document.createElement("div");
      left.style.minWidth = "0";
      left.innerHTML = `
        <div class="small"><strong>Punkt ${e.nr}</strong> <span class="muted">· ${escapeHtml(e.date)}</span></div>
        <div class="entry-meta">
          ${e.trackNo ? `<span class="chip">Strecke ${escapeHtml(e.trackNo)}</span>` : ``}
          ${e.km ? `<span class="chip">km ${escapeHtml(e.km)}</span>` : ``}
          ${e.site ? `<span class="chip">${escapeHtml(e.site)}</span>` : ``}
        </div>
        <div class="sep" style="margin:10px 0;"></div>
        <div class="muted" style="font-weight:800;margin-bottom:6px;">Mangel / Feststellung</div>
        <div class="small">${escapeHtml(e.note).replace(/\n/g,"<br>")}</div>
      `;

      const right = document.createElement("div");

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "danger";
      delBtn.textContent = "Löschen";
      delBtn.onclick = ()=>{
        state.entries = state.entries.filter(x=>x.id!==e.id);
        renumberEntries();
        renderEntries();
        updateButtons();
      };

      const info = document.createElement("div");
      info.className = "muted";
      info.style.marginBottom = "8px";
      info.textContent = `${e.photos.length} Foto${e.photos.length===1?"":"s"}`;

      right.appendChild(info);
      right.appendChild(delBtn);

      head.appendChild(left);
      head.appendChild(right);
      div.appendChild(head);

      if(e.photos.length){
        const thumbs = document.createElement("div");
        thumbs.className = "thumbs";
        for(const p of e.photos.slice(0,12)){
          const img = document.createElement("img");
          img.src = p.dataUrl;
          img.alt = p.name;
          img.title = "Tippen zum Vergrößern";
          img.addEventListener("click", ()=> openPhoto(p.name, p.dataUrl));
          thumbs.appendChild(img);
        }
        div.appendChild(thumbs);
      }

      entriesEl.appendChild(div);
    }
  }

  function renumberEntries(){
    state.entries.forEach((e, idx)=> e.nr = idx + 1);
  }

  btnAdd.addEventListener("click", async ()=>{
    const note = noteEl.value.trim();
    if(!note){ alert("Bitte Mangel/Feststellung eingeben."); return; }

    btnAdd.disabled = true;
    btnAdd.textContent = "Speichere…";

    try{
      const ts = nowISO();
      const photos = await readFilesAsDataUrls(photosEl.files);

      state.entries.push({
        id: uniqId(),
        tsISO: ts,
        date: formatLocal(ts),
        nr: state.entries.length + 1,

        site: siteEl.value.trim(),
        trackNo: trackNoPointEl.value.trim(),
        km: kmPointEl.value.trim(),

        note,
        photos
      });

      trackNoPointEl.value = "";
      kmPointEl.value = "";
      noteEl.value = "";
      photosEl.value = "";
      refreshPhotoPickerUI();

      noteEl.focus();
      renderEntries();
      updateButtons();
    }catch(e){
      console.error(e);
      alert("Fehler beim Lesen der Fotos.");
    }finally{
      btnAdd.disabled = false;
      btnAdd.textContent = "Punkt speichern";
    }
  });

  btnClearAll.addEventListener("click", ()=>{
    if(!confirm("Wirklich alle Punkte löschen?")) return;
    state.entries = [];
    renderEntries();
    updateButtons();
  });

  function buildBaseName(){
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const da=String(d.getDate()).padStart(2,"0");
    const proj=safeFileName(projectEl.value.trim()).slice(0,28);
    return `Begehungsprotokoll_${y}-${m}-${da}${proj?("_"+proj):""}`;
  }

  function buildWorkbook(){
    const rows = state.entries.map((e)=>({
      "Nr.": e.nr,
      "Datum/Uhrzeit": e.date,
      "Projekt": projectEl.value.trim() || "",
      "Ersteller": creatorEl.value.trim() || "",
      "Standort": e.site || "",
      "Streckennummer": e.trackNo || "",
      "km": e.km || "",
      "Wetter": weatherEl.value.trim() || "",
      "Temperatur (°C)": tempEl.value.toString().trim() || "",
      "Mangel/Feststellung": e.note,
      "Foto-Anzahl": e.photos.length,
      "Foto-Dateinamen": e.photos.map(p=>p.name).join("; ")
    }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Protokoll");
    return wb;
  }

  function setLastExport(label){
    const t = new Date().toLocaleString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    lastExportChip.textContent = `Letzter Export: ${label} · ${t}`;
  }

  btnExportXlsx.addEventListener("click", ()=>{
    try{
      XLSX.writeFile(buildWorkbook(), buildBaseName()+".xlsx");
      setLastExport("Excel");
    }catch(e){
      console.error(e);
      alert("Excel-Export fehlgeschlagen.");
    }
  });

  function guessExt(p){
    const m = String(p.dataUrl||"").match(/^data:(image\/[a-zA-Z0-9.+-]+);base64,/);
    const mime = m ? m[1] : (p.type||"");
    if(mime.includes("png")) return "png";
    if(mime.includes("webp")) return "webp";
    if(mime.includes("gif")) return "gif";
    return "jpg";
  }
  function dataUrlToUint8(dataUrl){
    const base64=dataUrl.split(",")[1]||"";
    const bin=atob(base64);
    const bytes=new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
    return bytes;
  }
  function downloadBlob(blob, filename){
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=filename;
    document.body.appendChild(a);
    a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),1000);
  }

  btnExportZip.addEventListener("click", async ()=>{
    try{
      const zip=new JSZip();
      const base=buildBaseName();
      const xlsxArray = XLSX.write(buildWorkbook(), { bookType:"xlsx", type:"array" });
      zip.file(base+".xlsx", xlsxArray);

      const imgFolder = zip.folder(base+"_Fotos");
      for(const e of state.entries){
        for(let i=0;i<e.photos.length;i++){
          const p=e.photos[i];
          const ext=guessExt(p);
          imgFolder.file(`Punkt_${e.nr}_${String(i+1).padStart(2,"0")}.${ext}`, dataUrlToUint8(p.dataUrl));
        }
      }

      const blob=await zip.generateAsync({type:"blob"});
      downloadBlob(blob, base+".zip");
      setLastExport("ZIP");
    }catch(e){
      console.error(e);
      alert("ZIP-Export fehlgeschlagen.");
    }
  });

  /* =========================
     PDF EXPORT (STABIL + FIX: Kein Quetschen)
     ========================= */
  function fitRect(w,h,maxW,maxH){
    const r=Math.min(maxW/w, maxH/h);
    return { w:w*r, h:h*r };
  }
  function loadImage(src){
    return new Promise((resolve,reject)=>{
      const img=new Image();
      img.onload=()=>resolve(img);
      img.onerror=reject;
      img.src=src;
    });
  }
  function getImageDims(dataUrl){
    return new Promise((resolve,reject)=>{
      const img=new Image();
      img.onload=()=>resolve({w:img.naturalWidth||img.width, h:img.naturalHeight||img.height});
      img.onerror=reject;
      img.src=dataUrl;
    });
  }
  async function ensureJpegOrPng(dataUrl){
    if(dataUrl.startsWith("data:image/jpeg") || dataUrl.startsWith("data:image/png")) return dataUrl;
    const img=await loadImage(dataUrl);
    const c=document.createElement("canvas");
    c.width=img.naturalWidth||img.width;
    c.height=img.naturalHeight||img.height;
    const ctx=c.getContext("2d");
    ctx.fillStyle="#ffffff";
    ctx.fillRect(0,0,c.width,c.height);
    ctx.drawImage(img,0,0);
    return c.toDataURL("image/jpeg",0.92);
  }

  btnExportPdf.addEventListener("click", async ()=>{
    try{
      btnExportPdf.disabled=true;
      btnExportPdf.textContent="Erstelle…";
      await exportPdfProfessional();
      setLastExport("PDF");
    }catch(e){
      console.error(e);
      alert("PDF-Export fehlgeschlagen: " + (e?.message || e));
    }finally{
      btnExportPdf.textContent="PDF";
      updateButtons();
    }
  });

  async function exportPdfProfessional(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"mm", format:"a4" });

    const margin=10;
    const project = pdfSafe(projectEl.value.trim() || "—");
    const creator = pdfSafe(creatorEl.value.trim() || "—");
    const createdDate = formatDateDE(new Date());

    doc.setFont("helvetica","bold"); doc.setFontSize(14);
    doc.text("Begehungsprotokoll", margin, 14);

    doc.setFontSize(10);
    doc.setFont("helvetica","bold");
    doc.text(`Projekt: ${project}`, margin, 20);

    doc.setFont("helvetica","normal");
    doc.text(`Ersteller: ${creator}`, margin, 25);
    doc.text(`Erstellt am: ${createdDate}`, margin, 30);

    const headerRows = [
      ["Wetter", pdfSafe(weatherEl.value.trim() || "—")],
      ["Temperatur (°C)", pdfSafe(tempEl.value.toString().trim() || "—")]
    ];

    doc.autoTable({
      startY: 34,
      body: headerRows,
      theme: "grid",
      styles: { fontSize: 9, cellPadding: 2 },
      margin: { left: margin, right: margin }
    });

    const startY = doc.lastAutoTable.finalY + 6;

    const colW = { nr: 8, date: 34, track: 18, km: 14, text: 46, photo: 70 }; // 190

    const photoCache = new Map();
    async function prepPhoto(p){
      if(!p?.dataUrl) return null;
      if(photoCache.has(p.dataUrl)) return photoCache.get(p.dataUrl);
      const url = await ensureJpegOrPng(p.dataUrl);
      const fmt = url.startsWith("data:image/png") ? "PNG" : "JPEG";
      const dims = await getImageDims(url);
      const obj = { url, fmt, w: dims.w, h: dims.h };
      photoCache.set(p.dataUrl, obj);
      return obj;
    }

    const maxRowH = 120;
    const minRowH = 42;

    const rowsMeta = [];
    const body = [];

    for(const e of state.entries){
      const textBlock = pdfSafe([
        e.site ? `Standort: ${e.site}` : null,
        e.note ? e.note : ""
      ].filter(Boolean).join("\n\n").trim());

      const p1 = e.photos?.[0] ? await prepPhoto(e.photos[0]) : null;
      const p2 = e.photos?.[1] ? await prepPhoto(e.photos[1]) : null;

      let rowH = minRowH;
      const usableW = colW.photo - 4;
      if(p1 && !p2){
        rowH = Math.min(maxRowH, Math.max(minRowH, usableW * (p1.h / p1.w) + 6));
      } else if(p1 && p2){
        const h1 = usableW * (p1.h / p1.w);
        const h2 = usableW * (p2.h / p2.w);
        rowH = Math.min(maxRowH, Math.max(minRowH, h1 + h2 + 8));
      }

      const meta = {
        hasPhoto: (e.photos?.length || 0) > 0,
        photos: [p1,p2].filter(Boolean),
        photoCount: e.photos?.length || 0,
        rowH
      };
      rowsMeta.push(meta);

      body.push([
        pdfSafe(String(e.nr ?? "")),
        pdfSafe(e.date || formatLocal(e.tsISO)),
        pdfSafe(e.trackNo || "—"),
        pdfSafe(e.km || "—"),
        textBlock,
        ""
      ]);
    }

    doc.autoTable({
      startY,
      theme:"grid",

      /* FIX: Zeilen NICHT quetschen -> ganze Zeile auf nächste Seite */
      rowPageBreak: "avoid",
      pageBreak: "auto",

      margin:{ left: margin, right: margin },
      head:[[ "Nr.", "Datum/Uhrzeit", "Strecke", "km", "Mangel / Feststellung", "Fotos" ]],
      body,
      styles:{ fontSize:9, cellPadding:2, valign:"top" },
      headStyles:{ fillColor:[240,240,240], fontStyle:"bold" },
      columnStyles:{
        0:{ cellWidth: colW.nr },
        1:{ cellWidth: colW.date },
        2:{ cellWidth: colW.track },
        3:{ cellWidth: colW.km },
        4:{ cellWidth: colW.text },
        5:{ cellWidth: colW.photo }
      },
      didParseCell:(data)=>{
        try{
          if(data.section!=="body") return;
          const idx = data.row.index;
          const meta = rowsMeta[idx];
          if(!meta) return;
          data.cell.styles.minCellHeight = meta.rowH;
        }catch(e){}
      },
      didDrawCell:(data)=>{
        try{
          if(data.section!=="body") return;
          if(data.column.index!==5) return;

          const idx = data.row.index;
          const meta = rowsMeta[idx];
          if(!meta) return;

          const cell = data.cell;
          const pad=1.5;
          const x=cell.x+pad, y=cell.y+pad;
          const w=cell.width-pad*2, h=cell.height-pad*2;

          if(!meta.photos.length){
            doc.setFont("helvetica","normal"); doc.setFontSize(9);
            doc.text("—", cell.x+cell.width/2, cell.y+8, {align:"center"});
            return;
          }

          const gap=2.2;
          const slots = meta.photos.length>=2 ? 2 : 1;
          const slotH = slots===2 ? (h-gap)/2 : h;

          for(let i=0;i<Math.min(2,meta.photos.length);i++){
            const ph=meta.photos[i];
            const boxY=y + i*(slotH+gap);
            const fitted = fitRect(ph.w, ph.h, w, slotH);
            const ix=x + (w-fitted.w)/2;
            const iy=boxY + (slotH-fitted.h)/2;
            doc.addImage(ph.url, ph.fmt, ix, iy, fitted.w, fitted.h);
          }

          if(meta.photoCount>2){
            doc.setFont("helvetica","bold"); doc.setFontSize(10);
            doc.text(`+${meta.photoCount-2}`, cell.x+cell.width-2, cell.y+cell.height-2, {align:"right"});
          }
        }catch(e){}
      }
    });

    const pageCount = doc.internal.getNumberOfPages();
    for(let p=1;p<=pageCount;p++){
      doc.setPage(p);
      doc.setFont("helvetica","normal"); doc.setFontSize(9);
      doc.text(pdfSafe(`Projekt: ${project}  |  Ersteller: ${creator}`), margin, 292);
      doc.text(`Seite ${p} / ${pageCount}`, 210-margin, 292, {align:"right"});
    }

    doc.save(buildBaseName()+".pdf");
  }

  /* ===== Location + Weather ===== */
  btnGeo.addEventListener("click", ()=>{
    if(!navigator.geolocation){ alert("Geolocation wird nicht unterstützt."); return; }
    btnGeo.disabled=true; btnGeo.textContent="…";
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      const {latitude,longitude}=pos.coords;
      try{
        const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`;
        const res=await fetch(url,{headers:{Accept:"application/json"}});
        const data=await res.json();
        siteEl.value = data.display_name || `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
      }catch{
        siteEl.value = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
      }finally{
        btnGeo.disabled=false; btnGeo.textContent="Standort automatisch";
      }
    }, ()=>{
      alert("Standort nicht verfügbar (Berechtigung/HTTPS).");
      btnGeo.disabled=false; btnGeo.textContent="Standort automatisch";
    }, {enableHighAccuracy:true, timeout:8000});
  });

  btnWeather.addEventListener("click", ()=>{
    if(!navigator.geolocation){ alert("Geolocation wird nicht unterstützt."); return; }
    btnWeather.disabled=true; btnWeather.textContent="…";
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      try{
        const {latitude,longitude}=pos.coords;
        const url=`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code&timezone=auto`;
        const res=await fetch(url);
        const data=await res.json();
        if(data && data.current){
          const t=data.current.temperature_2m;
          if(typeof t==="number") tempEl.value=t.toFixed(1);
          const w=mapWmoToText(data.current.weather_code);
          const options=Array.from(weatherEl.options).map(o=>o.value);
          weatherEl.value = options.includes(w) ? w : "";
        } else alert("Wetterdaten nicht verfügbar.");
      }catch{
        alert("Wetter konnte nicht geholt werden.");
      }finally{
        btnWeather.disabled=false; btnWeather.textContent="Wetter holen";
      }
    }, ()=>{
      alert("GPS-Berechtigung nötig.");
      btnWeather.disabled=false; btnWeather.textContent="Wetter holen";
    }, {enableHighAccuracy:true, timeout:8000});
  });

  function mapWmoToText(code){
    if(code===0) return "Sonnig";
    if([1,2].includes(code)) return "Leicht bewölkt";
    if(code===3) return "Bewölkt";
    if([45,48].includes(code)) return "Nebel";
    if([51,53,55].includes(code)) return "Nieselregen";
    if([61,63,65,80,81,82].includes(code)) return "Regen";
    if([66,67].includes(code)) return "Starkregen";
    if([71,73,75,77,85,86].includes(code)) return "Schnee";
    if([95,96,99].includes(code)) return "Gewitter";
    return "Bewölkt";
  }

  /* ===== Theme ===== */
  function getTheme(){ return document.body.getAttribute("data-theme") || "hell"; }
  function setTheme(t){
    document.body.setAttribute("data-theme", t);
    themeBtn.textContent = "Design: " + (t === "dunkel" ? "Dunkel" : "Hell");
    localStorage.setItem("proto_theme", t);
  }
  themeBtn.addEventListener("click", ()=>{
    setTheme(getTheme() === "dunkel" ? "hell" : "dunkel");
  });
  const savedTheme = localStorage.getItem("proto_theme");
  if(savedTheme === "hell" || savedTheme === "dunkel") setTheme(savedTheme);
  else setTheme("hell");

  updateLibStatus();
  updateButtons();
  renderEntries();
  setTimeout(()=>{ updateLibStatus(); updateButtons(); }, 400);
</script>
</body>
</html>
